# GitHub Actions CI/CD Workflow
# Google AMP Portfolio with Full Testing Pyramid & SonarCloud
#
# Pipeline Order:
# 1. Lint (ESLint + Stylelint)
# 2. Unit Tests (Vitest) → Coverage
# 3. SonarCloud Analysis
# 4. Build (Eleventy)
# 5. AMP Validation
# 6. E2E Tests (Cypress)
# 7. Deploy (if Quality Gate passes)

name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - ".gitignore"

  pull_request:
    branches: ["main"]

  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "22"

jobs:
  # STAGE 1: LINT
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for SonarCloud

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:js -- --format json --output-file eslint-report.json

      - name: Run Stylelint
        run: npm run lint:css -- --formatter json --output-file stylelint-report.json

      - name: TypeScript type check
        run: npm run typecheck

      - name: Upload lint reports
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            eslint-report.json
            stylelint-report.json
          retention-days: 7

  # STAGE 2: UNIT TESTS → COVERAGE
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Vitest with coverage
        run: npm run test:unit -- --coverage

      - name: Upload coverage and test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage/
            test-report.xml
          retention-days: 7

  # STAGE 3: SONARCLOUD ANALYSIS
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    timeout-minutes: 10
    # Note: SONAR_TOKEN is an optional secret - job gracefully skips if not configured
    env:
      # yamllint disable-line rule:truthy
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }} # pragma: allowlist secret
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full git history for accurate blame information

      - name: Download lint reports
        uses: actions/download-artifact@v4
        with:
          name: lint-reports
        continue-on-error: true

      - name: Download test and coverage reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports

      - name: SonarCloud Scan
        if: env.SONAR_TOKEN != ''
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Note: Quality Gate check is handled by sonar.qualitygate.wait=true
      # in sonar-project.properties - the scan will fail if gate fails

  # STAGE 4: BUILD (ELEVENTY)
  build:
    name: Build Site
    runs-on: ubuntu-latest
    # Build runs in parallel with Lint/Tests/Sonar to speed up feedback loop
    # needs: [] # No dependencies, starts immediately using source code
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build with Eleventy
        run: npm run build

      - name: Validate AMP HTML (Generated)
        run: npm run validate:amp

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: |
            _site/
            favicons/
            fonts/
            Images/
            sw.js
            sw.html
            CNAME
            robots.txt
            sitemap.xml
            ror.xml
            humans.txt
            browserconfig.xml
            .well-known/
          retention-days: 7

  # STAGE 5: E2E TESTS (CYPRESS)
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: ./

      - name: Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          start: npx serve _site -l 8080
          wait-on: "http://localhost:8080"
          wait-on-timeout: 60

      - name: Upload Cypress artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-artifacts
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 7

  # STAGE 6: LIGHTHOUSE CI (CORE WEB VITALS)
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: ./

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@latest

      - name: Run Lighthouse CI
        run: lhci autorun
        # Note: LHCI_GITHUB_APP_TOKEN is optional - enables GitHub status checks
        env:
          # yamllint disable-line rule:truthy
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }} # pragma: allowlist secret

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 7

  # STAGE 7: DEPLOY TO GITHUB PAGES
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    # Ensure deployment waits for ALL checks to pass (Quality + Functional)
    needs: [e2e-tests, lighthouse, sonarcloud]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 5
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: ./

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: "_site"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
