name: Nightly Quality
on:
  schedule:
    - cron: '0 0 * * *' # Midnight UTC
  workflow_dispatch:

jobs:
  quality-audit:
    name: Quality Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Bootstrap Environment
        uses: ./.github/actions/bootstrap-env
        with:
          node-version: '24'

      - name: Build Project
        run: npm run build

      - name: E2E Tests (Cypress)
        uses: cypress-io/github-action@v6
        with:
          install: false # Handled by bootstrap
          start: npm run serve
          wait-on: 'http://localhost:8080'
          browser: chrome
          config-file: cypress.config.ts
          # Only run smoke & a11y for nightly stability
          spec: |
            cypress/e2e/smoke.cy.ts
            cypress/e2e/a11y.cy.ts

      - name: Upload Cypress Artifacts (On Failure)
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          retention-days: 14

      # ========================================
      # Unit Tests & Coverage Generation
      # ========================================

      - name: üß™ Run Unit Tests with Coverage
        run: npm run test:unit:coverage

      - name: üìä Generate Lint Reports
        run: |
          npm run lint:js:report
          npm run lint:css:report

      # ========================================
      # SonarCloud Observability Strategy
      # Expert-Level Logging & Diagnostics
      # ========================================

      - name: üîç Pre-Scan Diagnostics
        run: |
          echo "::group::Working Directory Structure"
          pwd
          ls -la
          echo "::endgroup::"

          echo "::group::Coverage File Verification"
          if [ -f "coverage/lcov.info" ]; then
            echo "‚úÖ LCOV file found"
            echo "Size: $(stat -f%z coverage/lcov.info 2>/dev/null || stat -c%s coverage/lcov.info) bytes"
            echo "First 10 lines:"
            head -n 10 coverage/lcov.info
          else
            echo "‚ùå ERROR: coverage/lcov.info not found!"
            echo "This will cause Sonar to report 0% coverage."
            echo "Listing coverage directory:"
            ls -la coverage/ || echo "Coverage directory does not exist"
            exit 1
          fi
          echo "::endgroup::"

          echo "::group::Source File Mapping"
          echo "Source directories configured in sonar-project.properties:"
          grep "^sonar.sources=" sonar-project.properties || echo "No sources configured"
          echo ""
          echo "Verifying source files exist:"
          ls -la src/ scripts/ || true
          echo "::endgroup::"

      - name: üõ°Ô∏è Mask Sensitive Data
        run: |
          # Ensure SONAR_TOKEN is masked in all logs
          echo "::add-mask::${{ secrets.SONAR_TOKEN }}"
          echo "‚úÖ SONAR_TOKEN masked for all subsequent steps"

      - name: üìä Run SonarQube Scan (Verbose Mode)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "Starting SonarCloud scan with verbose diagnostics..."

          # Execute sonar-scanner with verbose logging and capture output
          # Using 'tee' to both display and save the log
          # Note: Reports already generated in previous steps (test coverage, lint reports)
          sonar-scanner \
            -Dsonar.verbose=true \
            -Dsonar.log.level=DEBUG \
            -Dsonar.scanner.dumpToFile=.scannerwork/scanner-dump.txt \
            2>&1 | tee sonar-analysis.log

          echo "‚úÖ Scan complete - logs saved to sonar-analysis.log"

      - name: üîß Extract Errors & Generate Summary
        if: always()
        run: |
          echo "Parsing SonarCloud logs for errors, warnings, and hotspots..."

          # Check if analysis log exists
          if [ ! -f "sonar-analysis.log" ]; then
            echo "‚ö†Ô∏è WARNING: sonar-analysis.log not found - scan may have failed early"
            echo "Skipping log parsing step"
            exit 0
          fi

          # Make scripts executable
          chmod +x scripts/parse-sonar-log.sh

          # Run log parser (exit code ignored - we want artifacts even if parsing fails)
          bash scripts/parse-sonar-log.sh sonar-analysis.log || true

          # Display summary in console
          if [ -f "sonar-errors-summary.md" ]; then
            echo "::group::Error Summary Preview"
            cat sonar-errors-summary.md
            echo "::endgroup::"
          fi

      - name: üìù Generate GitHub Step Summary
        if: always()
        run: |
          echo "Generating GitHub Actions Step Summary..."

          # Check if analysis log exists
          if [ ! -f "sonar-analysis.log" ]; then
            echo "‚ö†Ô∏è WARNING: sonar-analysis.log not found - skipping summary generation"
            exit 0
          fi

          # Make script executable
          chmod +x scripts/generate-sonar-summary.sh

          # Generate summary (requires GITHUB_STEP_SUMMARY env var)
          bash scripts/generate-sonar-summary.sh sonar-analysis.log sonar-errors-summary.md || true

          echo "‚úÖ Step summary generated"

      - name: üóúÔ∏è Compress Logs for Artifact Upload
        if: always()
        run: |
          echo "Compressing verbose logs to reduce artifact size..."

          # Check if analysis log exists before compressing
          if [ ! -f "sonar-analysis.log" ]; then
            echo "‚ö†Ô∏è WARNING: sonar-analysis.log not found - scan may have failed early"
            echo "Skipping compression step"
            exit 0
          fi

          # Compress main analysis log
          gzip -k sonar-analysis.log

          # Check size
          ORIGINAL_SIZE=$(stat -c%s sonar-analysis.log 2>/dev/null || stat -f%z sonar-analysis.log)
          COMPRESSED_SIZE=$(stat -c%s sonar-analysis.log.gz 2>/dev/null || stat -f%z sonar-analysis.log.gz)

          echo "Original: ${ORIGINAL_SIZE} bytes"
          echo "Compressed: ${COMPRESSED_SIZE} bytes"
          echo "Reduction: $(( (ORIGINAL_SIZE - COMPRESSED_SIZE) * 100 / ORIGINAL_SIZE ))%"

          # Safety check: truncate if still > 50MB
          MAX_SIZE=52428800  # 50MB
          if [ ${COMPRESSED_SIZE} -gt ${MAX_SIZE} ]; then
            echo "‚ö†Ô∏è WARNING: Compressed log exceeds 50MB, truncating..."
            # Keep last 50MB
            tail -c ${MAX_SIZE} sonar-analysis.log.gz > sonar-analysis-truncated.log.gz
            mv sonar-analysis-truncated.log.gz sonar-analysis.log.gz
          fi

      - name: üì¶ Upload SonarCloud Diagnostic Artifacts
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: sonarcloud-diagnostics
          retention-days: 14
          path: |
            sonar-analysis.log.gz
            sonar-errors-summary.md
            coverage/lcov.info
            .scannerwork/report-task.txt
            .scannerwork/scanner-dump.txt
          if-no-files-found: warn

      - name: ‚ùå Fail Build on Quality Gate Failure
        if: always()
        run: |
          # Check if analysis log exists
          if [ ! -f "sonar-analysis.log" ]; then
            echo "::error::SonarCloud scan failed - no analysis log generated"
            echo "Check previous steps for errors"
            exit 1
          fi

          # Check if Quality Gate passed by examining scanner output
          if grep -q "QUALITY GATE STATUS: FAILED" sonar-analysis.log; then
            echo "::error::SonarCloud Quality Gate FAILED"
            echo "Review the Step Summary above for details"
            exit 1
          elif grep -q "QUALITY GATE STATUS: PASSED" sonar-analysis.log; then
            echo "‚úÖ Quality Gate PASSED"
          else
            echo "‚ö†Ô∏è Quality Gate status unknown - check SonarCloud dashboard"
          fi
