<h1>SonarCloud Observability Implementation - User Guide</h1>
<blockquote>
<p><strong>Complete guide for using expert-level SonarCloud observability features</strong></p>
</blockquote>
<p><a href="../../README.md">üè† Home</a> / <a href="../README.md">üìö Docs</a> / <a href="README.md">Development</a> / SonarCloud
Observability</p>
<h2>Quick Navigation</h2>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#whats-new">What's New</a></li>
<li><a href="#accessing-artifacts">Accessing Artifacts</a></li>
<li><a href="#debugging-the-coverage-gap">Debugging Coverage Gap</a></li>
<li><a href="#security-hotspots---command-injection">Security Hotspots</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
<hr>
<h2>Overview</h2>
<p>This guide explains how to use the new expert-level SonarCloud observability features implemented in
the <code>nightly-quality.yml</code> workflow.</p>
<h2>What's New</h2>
<h3>1. <strong>Verbose Scanner Logs</strong></h3>
<p>The workflow now captures complete SonarCloud scanner output with verbose diagnostics enabled.</p>
<p><strong>Location:</strong> Available as artifact <code>sonar-analysis.log.gz</code> (compressed)</p>
<p><strong>Contains:</strong></p>
<ul>
<li>Detailed file analysis traces</li>
<li>LCOV path resolution details</li>
<li>Coverage ingestion diagnostics</li>
<li>Security hotspot detection logs</li>
<li>Quality Gate evaluation details</li>
</ul>
<h3>2. <strong>Error Summary Report</strong></h3>
<p>Automatically generated markdown summary of all issues found during the scan.</p>
<p><strong>Location:</strong> Available as artifact <code>sonar-errors-summary.md</code></p>
<p><strong>Contains:</strong></p>
<ul>
<li>Count of errors, warnings, and security hotspots</li>
<li>Categorized issue listings</li>
<li>Coverage analysis insights</li>
<li>File analysis breakdown</li>
<li>Diagnostic recommendations</li>
</ul>
<h3>3. <strong>GitHub Step Summary</strong></h3>
<p>Interactive summary displayed directly in the GitHub Actions UI.</p>
<p><strong>Location:</strong> Actions run summary page</p>
<p><strong>Contains:</strong></p>
<ul>
<li>Coverage percentage vs target (80%)</li>
<li>Security hotspots count by file</li>
<li>Links to uploaded artifacts</li>
<li>Next steps recommendations</li>
</ul>
<h3>4. <strong>Coverage Debugging</strong></h3>
<p>Pre-scan diagnostics verify coverage file existence and path mapping.</p>
<p><strong>Features:</strong></p>
<ul>
<li>Validates <code>coverage/lcov.info</code> exists before scan</li>
<li>Displays file size and preview</li>
<li>Verifies source directory structure</li>
<li>Exits early if coverage is missing</li>
</ul>
<h2>Accessing Artifacts</h2>
<p>After each workflow run:</p>
<ol>
<li>Go to the Actions tab in your repository</li>
<li>Click on the latest &quot;Nightly Quality&quot; run</li>
<li>Scroll to the bottom to find <strong>Artifacts</strong></li>
<li>Download <code>sonarcloud-diagnostics</code> (contains all diagnostic files)</li>
</ol>
<p><strong>Artifact Contents:</strong></p>
<ul>
<li><code>sonar-analysis.log.gz</code> - Full verbose scanner output (compressed)</li>
<li><code>sonar-errors-summary.md</code> - Condensed error report</li>
<li><code>coverage/lcov.info</code> - Raw Vitest coverage data</li>
<li><code>.scannerwork/report-task.txt</code> - Scan metadata</li>
<li><code>.scannerwork/scanner-dump.txt</code> - Scanner property dump</li>
</ul>
<p><strong>Retention:</strong> 14 days</p>
<h2>Debugging the &quot;Coverage Gap&quot;</h2>
<p>Your current issue: <strong>77.22% coverage vs 80% target</strong></p>
<h3>Step-by-Step Debugging</h3>
<ol>
<li>
<p><strong>Download the artifacts</strong> from the latest workflow run</p>
</li>
<li>
<p><strong>Decompress the verbose log:</strong></p>
<pre><code class="language-bash">gunzip sonar-analysis.log.gz
</code></pre>
</li>
<li>
<p><strong>Search for LCOV ingestion:</strong></p>
<pre><code class="language-bash">grep -i &quot;lcov&quot; sonar-analysis.log
grep -i &quot;coverage&quot; sonar-analysis.log
</code></pre>
</li>
<li>
<p><strong>Identify analyzed files:</strong></p>
<pre><code class="language-bash">grep &quot;Analysing&quot; sonar-analysis.log | grep -E &quot;(scripts|src)&quot;
</code></pre>
</li>
<li>
<p><strong>Compare with Vitest coverage:</strong></p>
<ul>
<li>Open <code>coverage/lcov.info</code></li>
<li>Check which files are listed</li>
<li>Compare paths with what Sonar analyzed</li>
</ul>
</li>
</ol>
<h3>Common Issues &amp; Fixes</h3>
<h4>Issue 1: Files Excluded from Coverage</h4>
<p><strong>Symptom:</strong> Vitest reports 80%+ but Sonar shows 77.22%</p>
<p><strong>Diagnosis:</strong></p>
<pre><code class="language-bash">grep &quot;EXCLUDED&quot; sonar-analysis.log | grep scripts
</code></pre>
<p><strong>Fix:</strong> Review <code>sonar.coverage.exclusions</code> in <code>sonar-project.properties</code> - ensure <code>scripts/</code> is not
excluded if you want it covered.</p>
<h4>Issue 2: Path Mapping Mismatch</h4>
<p><strong>Symptom:</strong> Sonar can't match LCOV paths to source files</p>
<p><strong>Diagnosis:</strong> Look for warnings like:</p>
<pre><code>WARN: Could not resolve path for file: scripts/housekeeping.ts
</code></pre>
<p><strong>Fix:</strong> Adjust <code>sonar.javascript.lcov.reportPaths</code> to use relative path or verify working
directory.</p>
<h4>Issue 3: Missing Tests</h4>
<p><strong>Symptom:</strong> Specific lines show as uncovered</p>
<p><strong>Diagnosis:</strong> Check the &quot;Scanner Context&quot; in verbose logs for exact line numbers.</p>
<p><strong>Fix:</strong> Add unit tests for the uncovered lines.</p>
<h2>Security Hotspots - Command Injection</h2>
<p>Your current issue: <strong>6 Security Hotspots in <code>scripts/</code></strong></p>
<h3>Files Affected</h3>
<ul>
<li><code>scripts/housekeeping.ts</code></li>
<li><code>scripts/validate-amp.ts</code></li>
</ul>
<h3>What Are They?</h3>
<p>SonarCloud flags potential <strong>Command Injection</strong> vulnerabilities where:</p>
<ul>
<li>User input could be passed to shell commands</li>
<li>Unsanitized strings are used in <code>child_process.exec()</code></li>
</ul>
<h3>How to Review</h3>
<ol>
<li><strong>Download <code>sonar-errors-summary.md</code></strong> from artifacts</li>
<li>Look for the &quot;Security Hotspots&quot; section</li>
<li>Review the specific code lines mentioned</li>
</ol>
<h3>Resolution Options</h3>
<p><strong>Option A: Mark as &quot;Safe&quot; (if false positive)</strong></p>
<ol>
<li>Go to SonarCloud UI ‚Üí Security Hotspots</li>
<li>Review each hotspot</li>
<li>If the input is trusted/sanitized, mark as &quot;Safe&quot;</li>
<li>Add comment explaining why it's safe</li>
</ol>
<p><strong>Option B: Fix the vulnerability</strong></p>
<ol>
<li>Sanitize all inputs before passing to shell</li>
<li>Use parameterized commands instead of string interpolation</li>
<li>Validate/whitelist allowed values</li>
</ol>
<p>Example fix:</p>
<pre><code class="language-typescript">// Before (flagged as hotspot)
const cmd = `docker exec ${containerName} ls`;
exec(cmd);

// After (safer)
const { execFile } = require('child_process');
execFile('docker', ['exec', containerName, 'ls']);
</code></pre>
<h2>Secret Masking</h2>
<p>The workflow automatically masks <code>SONAR_TOKEN</code> in all logs using GitHub's <code>::add-mask::</code> directive.</p>
<p><strong>Verification:</strong></p>
<ul>
<li>Check any uploaded artifacts</li>
<li><code>SONAR_TOKEN</code> should appear as <code>***</code> if accidentally included</li>
</ul>
<h2>Log Volume Management</h2>
<p><strong>Compression:</strong> Logs are compressed with <code>gzip</code> (typically 90% reduction)</p>
<p><strong>Truncation:</strong> If compressed log exceeds 50MB, it's truncated to prevent artifact limit issues</p>
<p><strong>Monitoring:</strong></p>
<pre><code class="language-bash"># After workflow completes, check artifact size
# GitHub UI shows artifact size
# If consistently near 50MB, consider reducing verbosity
</code></pre>
<h2>Best Practices</h2>
<h3>For Regular Runs</h3>
<ol>
<li>Review the GitHub Step Summary first (fastest)</li>
<li>If issues found, download <code>sonar-errors-summary.md</code></li>
<li>Only download full logs for deep debugging</li>
</ol>
<h3>For Coverage Gaps</h3>
<ol>
<li>Compare Vitest coverage report with Sonar's</li>
<li>Use verbose logs to identify path mismatches</li>
<li>Ensure all source files are properly configured</li>
</ol>
<h3>For Security Hotspots</h3>
<ol>
<li>Review in SonarCloud UI (visual, easier)</li>
<li>Use artifacts for offline review</li>
<li>Document decisions in SonarCloud comments</li>
</ol>
<h2>Troubleshooting</h2>
<h3>Workflow fails at &quot;Pre-Scan Diagnostics&quot;</h3>
<p><strong>Cause:</strong> <code>coverage/lcov.info</code> not found</p>
<p><strong>Fix:</strong> Ensure <code>npm run sonar:prepare</code> runs successfully (includes <code>npm run test:unit:coverage</code>)</p>
<h3>No artifacts uploaded</h3>
<p><strong>Cause:</strong> Workflow cancelled or artifact upload failed</p>
<p><strong>Fix:</strong> Check workflow logs for <code>upload-artifact</code> errors</p>
<h3>Step Summary empty</h3>
<p><strong>Cause:</strong> Script execution failed or <code>GITHUB_STEP_SUMMARY</code> not writable</p>
<p><strong>Fix:</strong> Review workflow logs for script errors</p>
<h2>Advanced: Scanner Property Dump</h2>
<p>The workflow generates <code>.scannerwork/scanner-dump.txt</code> which contains all resolved properties.</p>
<p><strong>Use Case:</strong> Debug property inheritance and overrides</p>
<p><strong>Example:</strong></p>
<pre><code class="language-bash"># View all resolved Sonar properties
cat .scannerwork/scanner-dump.txt | grep &quot;sonar.javascript&quot;
</code></pre>
<p>This shows exactly what values the scanner used, resolving any confusion about CLI overrides vs
properties file.</p>
<h2>Support</h2>
<p>If you encounter issues:</p>
<ol>
<li>Check the GitHub Step Summary for high-level overview</li>
<li>Review <code>sonar-errors-summary.md</code> for categorized issues</li>
<li>Search <code>sonar-analysis.log</code> for specific error messages</li>
<li>Compare LCOV file paths with Sonar's analyzed files</li>
</ol>
<p>For persistent issues, export the relevant log sections when asking for help.</p>
<hr>
<h2>Related Documentation</h2>
<ul>
<li><strong><a href="README.md">Development Guide</a></strong> - Development setup and workflows</li>
<li><strong><a href="TESTING.md">Testing Guide</a></strong> - Testing requirements and strategies</li>
<li><strong><a href="../quick-reference/SONARCLOUD.md">Quick Reference</a></strong> - SonarCloud quick commands</li>
<li><strong><a href="../../scripts/README.md">Scripts README</a></strong> - Diagnostic script documentation</li>
</ul>
<hr>
<p><strong>Last Updated:</strong> 2025-12-23 <strong>Workflow Version:</strong> Expert-Level Observability v1.0</p>
<p><a href="#sonarcloud-observability-implementation---user-guide">‚Üë Back to Top</a></p>
